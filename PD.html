<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sofia Police Departments Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <style>
        #map { height: 600px; }
        #search { margin-bottom: 10px; }
    </style>
</head>
<body style="background-color:rgb(158, 154, 154)">
    <h1 style="font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;font-style: italic; color: rgb(243, 247, 247);">Карта на полицейските управления в гр.София</h1>
    <div id="search">
        <input type="text" id="streetInput" placeholder="Въведете улица" style="width: min-content;">
        <button onclick="searchStreet()">Търси улица</button>
    </div>
    <div id="map"></div>
    <br>
    <hr style="color: rgb(243, 247, 247); width: 77%; margin: auto;">
    <div id="info" style="color: rgb(243, 247, 247);"></div>

    <script>
        const map = L.map('map', {
            zoomControl: true // Enable zoom control
        }).setView([42.6977, 23.3219], 12);
        
        // Customize zoom control position
        map.zoomControl.setPosition('topleft');

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let geojsonLayer;
        let polygons = {};

        const correctInfo = {
            'sdvr_rpu1': {
                name: '01 РУП',
                address: 'София, ж.к. “Гео Милев”, бул. "Шипченски проход" №8, пощенски код 1113',
                telephone: '02/982 7166; 02/982 7167; факс: 02/982 7147',
                description: 'Обслужваната от 01 РУ СДВР територия обхваща три административни столични района: Средец, Слатина и Изгрев. Населението на територията на 01 РУ СДВР е около 166 000 души. На територията на 01 РУ СДВР се намират сградите на редица министерства, посолства и агенции. Наличието на основни за столицата спортни съоръжения, обуславя необходимостта от пряко участие в охраната на спортни и културни мероприятия.Всички трасета за посрещане и изпращане на междуправителствени делегации минават през района на 01 РУ СДВР'
            },
            'sdvr_rpu9': {
                name: '09 РУП',
                address: 'София, ж.к. “Люлин IV” бл. 464, пощенски код 1359',
                telephone: '02/982 5600; 02/982 5601; 02/824 3655',
                description: 'Обслужваната от 09 РУ СДВР територия обхваща три административни столични района: Люлин, Връбница и Банкя.Населението на територията на 09 РУ СДВР е приблизително 190 700 души, което представлява около 14 % от населението на столицата.През територията на 09 РУ СДВР преминават важни пътища и местно и национално значение, с интензивен поток от автомобили на чужди и наши граждани. Дължината на основната пътна мрежа в обслужвания район е 765 км.Околовръстен път е изходна точка за АМ Струма.Бул. "Сливница" е изходна точка за ГКПП-Калотина.Бул. "Ломско шосе" е основна пътна артерия, осигуряваща вход/изход за и от гр. София към северозападна България.През територията на 09 РУ СДВР минават и главните европейски пътища Е-79 и Е-80'
            }
        };

        fetch('https://raw.githubusercontent.com/yurukov/Bulgaria-geocoding/master/rpu_sofia.geojson')
            .then(response => response.json())
            .then(data => {
                geojsonLayer = L.geoJSON(data, {
                    style: function(feature) {
                        return {
                            color: getRandomColor(),
                            weight: 2,
                            opacity: 0.65
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const id = feature.properties.id;
                        if (correctInfo[id]) {
                            Object.assign(feature.properties, correctInfo[id]);
                        }
                        polygons[id] = layer;
                        layer.bindPopup(`
                            <b>${feature.properties.name}</b><br>
                            Адрес: ${feature.properties.address}<br>
                            Телефон: ${feature.properties.telephone}<br>
                            Полезна информация: ${feature.properties.description}
                        `);
                        layer.on('click', function() {
                            showInfo(feature.properties);
                        });
                    }
                }).addTo(map);
            });

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function showInfo(props) {
            document.getElementById('info').innerHTML = `
                <h2>${props.name}</h2>
                <p>Адрес: ${props.address}</p>
                <p>Телефони: ${props.telephone}</p>
                <p>Полезна информация: ${props.description}</p>
            `;
            highlightPolygon(props.id);
        }

        let currentHighlight;
        function highlightPolygon(id) {
            if (currentHighlight) {
                geojsonLayer.resetStyle(currentHighlight);
            }
            currentHighlight = polygons[id];
            currentHighlight.setStyle({weight: 5, color: '#666', dashArray: '', fillOpacity: 0.7});
            currentHighlight.bringToFront();
        }

        let searchMarker;
        function searchStreet() {
            const street = document.getElementById('streetInput').value;
            if (!street) return;

            fetch(`https://nominatim.openstreetmap.org/search?city=Sofia&street=${encodeURIComponent(street)}&format=json&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        alert('Улицата не е открита');
                        return;
                    }
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    map.setView([lat, lon], 15);

                    if (searchMarker) map.removeLayer(searchMarker);
                    searchMarker = L.marker([lat, lon]).addTo(map).bindPopup(`Street: ${street}`).openPopup();

                    const point = turf.point([lon, lat]);
                    let found = false;
                    geojsonLayer.eachLayer(layer => {
                        if (found) return;
                        if (layer.feature && turf.booleanPointInPolygon(point, layer.feature)) {
                            showInfo(layer.feature.properties);
                            found = true;
                        }
                    });
                    if (!found) {
                        document.getElementById('info').innerHTML = '<p>Не е открито полицейски управление, обслужващо тази територия</p>';
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>